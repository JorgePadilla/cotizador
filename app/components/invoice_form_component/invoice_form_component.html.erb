<%= form_with(model: invoice, class: "space-y-6", data: { 
      controller: "invoice-form",
      invoice_form_default_tax_percentage_value: current_user&.default_tax ? (current_user.default_tax * 100).round(2) : 15
    }) do |form| %>
  <% if invoice.errors.any? %>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
      <strong class="font-bold">Error:</strong>
      <span class="block sm:inline"><%= pluralize(invoice.errors.count, "error") %> prohibited this invoice from being saved:</span>
      <ul class="list-disc list-inside mt-2">
        <% invoice.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= form.label :invoice_number, class: "block text-sm font-medium text-gray-700" %>
        <%= form.text_field :invoice_number, class: "mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" %>
      </div>

      <div>
        <%= form.label :client_id, class: "block text-sm font-medium text-gray-700" %>
        <%= form.collection_select :client_id, clients, :id, :name, 
                                  { include_blank: "Select a client" }, 
                                  { class: "mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" } %>
      </div>

      <div>
        <%= form.label :status, class: "block text-sm font-medium text-gray-700" %>
        <%= form.select :status, 
                        [['Draft', 'draft'], ['Pending', 'pending'], ['Paid', 'paid'], ['Cancelled', 'cancelled']], 
                        { include_blank: false }, 
                        { class: "mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" } %>
      </div>

      <div>
        <%= form.label :payment_method, class: "block text-sm font-medium text-gray-700" %>
        <%= form.select :payment_method, 
                        [['Cash', 'cash'], ['Credit Card', 'credit_card'], ['Bank Transfer', 'bank_transfer'], ['Check', 'check']], 
                        { include_blank: "Select payment method" }, 
                        { class: "mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" } %>
      </div>
    </div>
  </div>

  <h3 class="text-lg font-medium text-gray-900 mt-8 mb-4">Invoice Items</h3>
  <div class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
    <div class="mb-4">
      <div id="invoice-items" data-invoice-form-target="itemsContainer">
        <% if invoice.invoice_items.empty? %>
          <div class="invoice-item-fields grid grid-cols-1 md:grid-cols-5 gap-4 border-b pb-4 mb-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700">Product</label>
              <select name="invoice[invoice_items_attributes][0][product_id]" 
                      class="product-select mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      data-action="change->invoice-form#updatePrice">
                <option value="">Select a product</option>
                <% Product.all.each do |product| %>
                  <option value="<%= product.id %>" data-price="<%= product.price %>"><%= product.name %> - <%= number_to_currency(product.price) %></option>
                <% end %>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Quantity</label>
              <input type="number" 
                     name="invoice[invoice_items_attributes][0][quantity]" 
                     min="1" 
                     value="1" 
                     class="quantity-input mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                     data-action="input->invoice-form#updateTotals">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Unit Price</label>
              <input type="number" 
                     step="0.01" 
                     name="invoice[invoice_items_attributes][0][unit_price]" 
                     class="price-input mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-50 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" 
                     readonly>
            </div>
            <div class="flex items-end">
              <button type="button" 
                      class="remove-item-btn mt-1 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
                      data-action="click->invoice-form#removeItem">
                Remove
              </button>
            </div>
          </div>
        <% else %>
          <% invoice.invoice_items.each_with_index do |item, index| %>
            <div class="invoice-item-fields grid grid-cols-1 md:grid-cols-5 gap-4 border-b pb-4 mb-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700">Product</label>
                <select name="invoice[invoice_items_attributes][#{index}][product_id]" 
                        class="product-select mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        data-action="change->invoice-form#updatePrice">
                  <option value="">Select a product</option>
                  <% Product.all.each do |product| %>
                    <option value="<%= product.id %>" data-price="<%= product.price %>" <%= 'selected' if product.id == item.product_id %>>
                      <%= product.name %> - <%= number_to_currency(product.price) %>
                    </option>
                  <% end %>
                </select>
                <%= hidden_field_tag "invoice[invoice_items_attributes][#{index}][id]", item.id if item.persisted? %>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Quantity</label>
                <%= number_field_tag "invoice[invoice_items_attributes][#{index}][quantity]", 
                                    item.quantity, 
                                    min: 1, 
                                    class: "quantity-input mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm",
                                    data: { action: "input->invoice-form#updateTotals" } %>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Unit Price</label>
                <%= number_field_tag "invoice[invoice_items_attributes][#{index}][unit_price]", 
                                    item.unit_price, 
                                    step: "0.01", 
                                    readonly: true,
                                    class: "price-input mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-50 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
              </div>
              <div class="flex items-end">
                <button type="button" 
                        class="remove-item-btn mt-1 bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded"
                        data-action="click->invoice-form#removeItem">
                  Remove
                </button>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>

      <button type="button" 
              class="mt-4 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
              data-invoice-form-target="addButton"
              data-action="click->invoice-form#addItem">
        Add Item
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
      <div>
        <%= form.label :subtotal, class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :subtotal, 
                             step: "0.01", 
                             class: "mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md", 
                             readonly: true,
                             data: { invoice_form_target: "subtotal" } %>
      </div>

      <div>
        <%= form.label :tax, class: "block text-sm font-medium text-gray-700" %>
        <% default_tax_percentage = current_user&.default_tax ? (current_user.default_tax * 100).round(2) : 15 %>
        <%= form.number_field :tax, 
                             value: default_tax_amount, 
                             step: "0.01", 
                             data: { 
                               default_tax_percentage: default_tax_percentage,
                               invoice_form_target: "tax",
                               action: "input->invoice-form#updateTotals"
                             },
                             class: "mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" %>
      </div>

      <div>
        <%= form.label :total, class: "block text-sm font-medium text-gray-700" %>
        <%= form.number_field :total, 
                             step: "0.01", 
                             class: "mt-1 focus:ring-blue-500 focus:border-blue-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md", 
                             readonly: true,
                             data: { invoice_form_target: "total" } %>
      </div>
    </div>
  </div>

  <div class="flex justify-end space-x-3 mt-8">
    <%= link_to "Cancel", invoices_path, class: "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded" %>
    <%= form.submit class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded cursor-pointer" %>
  </div>
<% end %>
